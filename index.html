<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Financeiro Master Cloud</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; background: #f0f2f5; margin: 0; }
        #auth-card { background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 300px; text-align: center; }
        #app-content { display: none; width: 90%; max-width: 800px; background: white; padding: 20px; border-radius: 8px; }
        input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button { width: 100%; padding: 10px; background: #1a73e8; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .row { display: flex; gap: 10px; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="auth-card">
        <h2>Login Financeiro</h2>
        <input type="email" id="email" placeholder="E-mail">
        <input type="password" id="password" placeholder="Senha">
        <button onclick="handleLogin()">Entrar / Cadastrar</button>
        <p id="msg" style="color: red; font-size: 12px;"></p>
    </div>

    <div id="app-content">
        <div style="display: flex; justify-content: space-between;">
            <h2>Minhas Finanças</h2>
            <button onclick="saveData()" style="width: auto; background: #34a853;">Salvar na Nuvem</button>
        </div>
        <div id="lista"></div>
        <button onclick="addRow()" style="background: #5f6368; margin-top: 10px;">+ Adicionar Item</button>
    </div>

<script>
    // --- SUBSTITUA APENAS ESTAS DUAS LINHAS ---
    const SUPABASE_URL = 'https://xpamnljjxvfnpzdmuive.supabase.co'; 
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhwYW1ubGpqeHZmbnB6ZG11aXZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzOTA2ODIsImV4cCI6MjA4NTk2NjY4Mn0.ePhhjJcpYAiVM3f6LRD66LKVhnUv854lvztudybx6_Q';
    // -----------------------------------------

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    let userSession = null;

    async function handleLogin() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const msg = document.getElementById('msg');

        // Tenta Logar
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });

        if (error) {
            // Se não logou, tenta cadastrar automaticamente
            const { data: signupData, error: signupError } = await supabase.auth.signUp({ email, password });
            if (signupError) {
                msg.innerText = "Erro: " + signupError.message;
            } else {
                msg.style.color = "green";
                msg.innerText = "Conta criada! Tente clicar em entrar agora.";
            }
        } else {
            userSession = data.user;
            startApp();
        }
    }

    function startApp() {
        document.getElementById('auth-card').style.display = 'none';
        document.getElementById('app-content').style.display = 'block';
        loadData();
    }

    function addRow(val = {d: '', v: ''}) {
        const div = document.createElement('div');
        div.className = 'row';
        div.innerHTML = `
            <input type="text" placeholder="Descrição" class="desc" value="${val.d}">
            <input type="number" placeholder="R$" class="valor" value="${val.v}">
            <button onclick="this.parentElement.remove()" style="width:40px; background:#ea4335">X</button>
        `;
        document.getElementById('lista').appendChild(div);
    }

    async function saveData() {
        const items = Array.from(document.querySelectorAll('.row')).map(row => ({
            d: row.querySelector('.desc').value,
            v: row.querySelector('.valor').value
        }));

        const { error } = await supabase.from('finance_data').upsert({
            id: userSession.id,
            content: items,
            updated_at: new Date()
        });

        if (error) alert("Erro ao salvar: " + error.message);
        else alert("Salvo com sucesso!");
    }

    async function loadData() {
        const { data } = await supabase.from('finance_data').select('content').eq('id', userSession.id).single();
        if (data && data.content) {
            data.content.forEach(item => addRow(item));
        } else {
            addRow(); // Começa com uma linha vazia
        }
    }
</script>
</body>
</html>
