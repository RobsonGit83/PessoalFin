<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financeiro Master Pro 2026</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #1e293b; --accent: #3b82f6; --success: #10b981;
            --danger: #ef4444; --bg: #f1f5f9; --white: #ffffff;
            --text: #334155; --card-bg: #ffffff; --border: #e2e8f0;
        }

        body.dark {
            --primary: #f8fafc; --accent: #60a5fa; --success: #34d399;
            --danger: #f87171; --bg: #0f172a; --white: #1e293b;
            --text: #f1f5f9; --card-bg: #1e293b; --border: #334155;
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; transition: 0.3s; }
        .container { max-width: 1400px; margin: 0 auto; }

        /* Header & Nav */
        header { display: flex; justify-content: space-between; align-items: center; background: var(--card-bg); padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 20px; border: 1px solid var(--border); }
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; }

        /* Cards de Resumo */
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .card { background: var(--card-bg); padding: 20px; border-radius: 16px; border: 1px solid var(--border); box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .card h3 { margin: 0; font-size: 13px; text-transform: uppercase; opacity: 0.7; }
        .card p { margin: 10px 0 0; font-size: 22px; font-weight: 800; }

        /* Tabelas */
        .section-box { background: var(--card-bg); padding: 20px; border-radius: 16px; margin-bottom: 25px; border: 1px solid var(--border); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        th { padding: 12px; font-size: 11px; text-align: center; border-bottom: 2px solid var(--border); }
        td { padding: 6px; border-bottom: 1px solid var(--border); }
        input { background: transparent; color: var(--text); border: 1px solid var(--border); border-radius: 4px; padding: 6px; width: 100%; box-sizing: border-box; }
        input[type="number"] { width: 65px; text-align: right; }

        /* Calculadora Moderna */
        #calc { position: fixed; bottom: 30px; right: 30px; width: 260px; background: rgba(30, 41, 59, 0.9); backdrop-filter: blur(10px); padding: 15px; border-radius: 20px; box-shadow: 0 20px 25px rgba(0,0,0,0.2); display: none; z-index: 1000; border: 1px solid rgba(255,255,255,0.1); }
        .calc-screen { width: 100%; height: 50px; background: #000; color: #fff; border: none; border-radius: 10px; margin-bottom: 10px; text-align: right; padding: 10px; font-size: 20px; box-sizing: border-box; }
        .calc-btns { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .calc-btns button { padding: 12px; border-radius: 8px; border: none; cursor: pointer; background: #334155; color: white; font-weight: bold; }
        .calc-btns button:hover { background: #475569; }

        /* Gr√°fico */
        .chart-container { background: var(--card-bg); padding: 25px; border-radius: 16px; border: 1px solid var(--border); height: 350px; }

        button { cursor: pointer; border-radius: 8px; font-weight: bold; border: none; padding: 10px 15px; transition: 0.2s; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h2 style="margin:0;">üè¶ Finan√ßas Pro</h2>
        <div class="btn-group">
            <button class="btn-primary" onclick="toggleDark()">üåì Modo Dark</button>
            <button class="btn-primary" onclick="toggleCalc()">üñ© Calculadora</button>
            <button class="btn-success" onclick="saveData()">üíæ Salvar Dados</button>
            <button onclick="location.reload()" style="background:#64748b; color:white;">üîí Sair</button>
        </div>
    </header>

    <div class="summary-grid">
        <div class="card" style="border-top: 4px solid var(--success);"><h3>Receitas</h3><p id="res-r" style="color: var(--success);">R$ 0,00</p></div>
        <div class="card" style="border-top: 4px solid var(--danger);"><h3>Despesas</h3><p id="res-p" style="color: var(--danger);">R$ 0,00</p></div>
        <div class="card" style="border-top: 4px solid var(--accent);"><h3>Investido</h3><p id="res-a" style="color: var(--accent);">R$ 0,00</p></div>
        <div class="card" style="border-top: 4px solid #f59e0b;"><h3>Saldo Final</h3><p id="res-s">R$ 0,00</p></div>
    </div>

    <div class="section-box">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
            <h3 style="margin:0;">üìâ Controle de Fluxo Anual</h3>
            <div class="btn-group">
                <button class="btn-success" onclick="addRow('tbody-receber', 'v-r')">+ Receita</button>
                <button class="btn-danger" onclick="addRow('tbody-pagar', 'v-p')">+ Despesa</button>
                <button class="btn-primary" onclick="addRow('tbody-aportes', 'v-a')">+ Aporte</button>
            </div>
        </div>
        <table>
            <thead id="month-labels"></thead>
            <tbody id="tbody-receber"></tbody>
            <tbody id="tbody-pagar"></tbody>
            <tbody id="tbody-aportes"></tbody>
        </table>
    </div>

    <div class="chart-container">
        <canvas id="expenseChart"></canvas>
    </div>
</div>

<div id="calc">
    <input type="text" class="calc-screen" id="display" disabled>
    <div class="calc-btns">
        <button onclick="clearCalc()" style="background:var(--danger)">C</button>
        <button onclick="btnCalc('/')">/</button>
        <button onclick="btnCalc('*')">*</button>
        <button onclick="backCalc()">‚Üê</button>
        <button onclick="btnCalc('7')">7</button><button onclick="btnCalc('8')">8</button>
        <button onclick="btnCalc('9')">9</button><button onclick="btnCalc('-')">-</button>
        <button onclick="btnCalc('4')">4</button><button onclick="btnCalc('5')">5</button>
        <button onclick="btnCalc('6')">6</button><button onclick="btnCalc('+')">+</button>
        <button onclick="btnCalc('1')">1</button><button onclick="btnCalc('2')">2</button>
        <button onclick="btnCalc('3')">3</button>
        <button onclick="resCalc()" style="grid-row: span 2; background:var(--success)">=</button>
        <button onclick="btnCalc('0')" style="grid-column: span 2">0</button>
        <button onclick="btnCalc('.')">.</button>
    </div>
</div>

<script>
    // --- SUPABASE CONFIG ---
    const S_URL = 'https://xpamnljjxvfnpzdmuive.supabase.co'; 
    const S_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhwYW1ubGpqeHZmbnB6ZG11aXZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzOTA2ODIsImV4cCI6MjA4NTk2NjY4Mn0.ePhhjJcpYAiVM3f6LRD66LKVhnUv854lvztudybx6_Q';
    const supabaseClient = window.supabase.createClient(S_URL, S_KEY);
    
    let userLogged = null;
    let chart;
    const months = ['JAN','FEV','MAR','ABR','MAI','JUN','JUL','AGO','SET','OUT','NOV','DEZ'];

    window.onload = async () => {
        initMonths();
        initChart();
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (user) { userLogged = user; loadData(); }
    };

    function initMonths() {
        const header = document.getElementById('month-labels');
        header.innerHTML = `<tr><th>TIPO</th><th style="text-align:left">DESCRI√á√ÉO</th>` + 
            months.map(m => `<th>${m}</th>`).join('') + `<th>TOTAL</th></tr>`;
    }

    function addRow(target, type, data = null) {
        const tbody = document.getElementById(target);
        const tr = document.createElement('tr');
        const color = type === 'v-r' ? 'var(--success)' : (type === 'v-p' ? 'var(--danger)' : 'var(--accent)');
        
        let inputs = '';
        for(let i=0; i<12; i++) {
            inputs += `<td><input type="number" class="val-input ${type}" value="${data ? data.vals[i] : 0}" oninput="updateAll()"></td>`;
        }

        tr.innerHTML = `
            <td style="color:${color}; font-weight:bold; font-size:10px">${type.replace('v-','').toUpperCase()}</td>
            <td><input type="text" class="desc-input" value="${data ? data.desc : ''}"></td>
            ${inputs}
            <td class="total-row" style="font-weight:bold; text-align:right">0</td>
        `;
        tbody.appendChild(tr);
        updateAll();
    }

    function updateAll() {
        let tR = 0, tP = 0, tA = 0;
        let monthlyExpenses = Array(12).fill(0);

        document.querySelectorAll('tr').forEach(row => {
            const inputs = row.querySelectorAll('.val-input');
            if(inputs.length > 0) {
                let rowSum = 0;
                inputs.forEach((input, idx) => {
                    const v = parseFloat(input.value) || 0;
                    rowSum += v;
                    if(input.classList.contains('v-r')) tR += v;
                    if(input.classList.contains('v-p')) { tP += v; monthlyExpenses[idx] += v; }
                    if(input.classList.contains('v-a')) tA += v;
                });
                row.querySelector('.total-row').innerText = rowSum.toFixed(2);
            }
        });

        document.getElementById('res-r').innerText = "R$ " + tR.toFixed(2);
        document.getElementById('res-p').innerText = "R$ " + tP.toFixed(2);
        document.getElementById('res-a').innerText = "R$ " + tA.toFixed(2);
        document.getElementById('res-s').innerText = "R$ " + (tR - tP - tA).toFixed(2);

        chart.data.datasets[0].data = monthlyExpenses;
        chart.update();
    }

    // --- GR√ÅFICO ---
    function initChart() {
        const ctx = document.getElementById('expenseChart').getContext('2d');
        chart = new Chart(ctx, {
            type: 'bar',
            data: { labels: months, datasets: [{ label: 'Gastos Mensais', data: [], backgroundColor: '#ef4444', borderRadius: 8 }] },
            options: { 
                maintainAspectRatio: false, 
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true, grid: { color: '#e2e8f0' } } }
            }
        });
    }

    // --- CALCULADORA ---
    function toggleCalc() { const c = document.getElementById('calc'); c.style.display = c.style.display === 'block' ? 'none' : 'block'; }
    function btnCalc(v) { document.getElementById('display').value += v; }
    function clearCalc() { document.getElementById('display').value = ''; }
    function backCalc() { const d = document.getElementById('display'); d.value = d.value.slice(0, -1); }
    function resCalc() { 
        try { document.getElementById('display').value = eval(document.getElementById('display').value); } 
        catch { document.getElementById('display').value = 'Erro'; }
    }

    // --- MODO DARK ---
    function toggleDark() { 
        document.body.classList.toggle('dark'); 
        chart.options.scales.y.grid.color = document.body.classList.contains('dark') ? '#334155' : '#e2e8f0';
        chart.update();
    }

    // --- PERSIST√äNCIA ---
    async function saveData() {
        const getItems = (id) => Array.from(document.querySelectorAll(`#${id} tr`)).map(tr => ({
            desc: tr.querySelector('.desc-input').value,
            vals: Array.from(tr.querySelectorAll('.val-input')).map(i => i.value)
        }));

        const payload = { r: getItems('tbody-receber'), p: getItems('tbody-pagar'), a: getItems('tbody-aportes') };
        await supabaseClient.from('finance_data').upsert({ id: userLogged.id, content: payload, updated_at: new Date() });
        alert("Dados salvos com sucesso! ‚òÅÔ∏è");
    }

    async function loadData() {
        const { data } = await supabaseClient.from('finance_data').select('content').eq('id', userLogged.id).maybeSingle();
        if(data && data.content) {
            data.content.r.forEach(x => addRow('tbody-receber', 'v-r', x));
            data.content.p.forEach(x => addRow('tbody-pagar', 'v-p', x));
            data.content.a.forEach(x => addRow('tbody-aportes', 'v-a', x));
        }
    }
</script>
</body>
</html>
